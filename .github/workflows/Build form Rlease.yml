name: Build Aseprite (Latest Release Source)

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  get-skia-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.result }}
    steps:
    - name: Get latest Skia version
      id: get-version
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data } = await github.rest.repos.getLatestRelease({
            owner: 'aseprite',
            repo: 'skia'
          });
          return data.tag_name;
        result-encoding: string

  get-aseprite-source:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.get-src.outputs.tag }}
      url: ${{ steps.get-src.outputs.url }}
    steps:
    - name: Get latest Aseprite Source.zip
      id: get-src
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: release } = await github.rest.repos.getLatestRelease({
            owner: 'aseprite',
            repo: 'aseprite'
          });
          const asset = release.assets.find(a => a.name.endsWith('Source.zip'));
          if (!asset) {
            core.setFailed('Cannot find Source.zip asset in latest release');
            return;
          }
          core.setOutput('tag', release.tag_name);
          core.setOutput('url', asset.browser_download_url);

  build-windows:
    runs-on: windows-latest
    needs: [get-skia-version, get-aseprite-source]
    steps:
    - name: Install Windows dependencies
      run: |
        choco install cmake ninja -y

    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64
        vsversion: 2022

    - name: Sanitize PATH (remove Git OpenSSL)
      shell: pwsh
      run: |
        $before = $env:Path
        $paths = $before -split ';' | Where-Object {
          $_ -and ($_ -notmatch 'Git\\usr\\bin') -and ($_ -notmatch 'Git\\mingw64\\bin') -and ($_ -notmatch 'Git\\bin')
        }
        $env:Path = ($paths) -join ';'
        Write-Host "PATH sanitized."

    - name: Download Aseprite Source (latest release)
      shell: pwsh
      run: |
        $url = "${{ needs.get-aseprite-source.outputs.url }}"
        $tag = "${{ needs.get-aseprite-source.outputs.tag }}"
        Write-Host "Downloading Aseprite Source from $url (tag: $tag)"
        Invoke-WebRequest -Uri $url -OutFile aseprite-source.zip
        if ((Get-Item aseprite-source.zip).Length -lt 5000000) {
          Write-Error "Source.zip too small, download may have failed."
          exit 1
        }
        if (Test-Path aseprite-src) { Remove-Item -Recurse -Force aseprite-src }
        New-Item -ItemType Directory -Path aseprite-src | Out-Null
        Expand-Archive -Path aseprite-source.zip -DestinationPath aseprite-src

        $rootPath = (Resolve-Path 'aseprite-src').Path
        $cmakeAtRoot = Test-Path (Join-Path $rootPath 'CMakeLists.txt')
        if ($cmakeAtRoot) {
          $srcDir = $rootPath
        } else {
          $candidate = Get-ChildItem "aseprite-src" -Directory | Where-Object { Test-Path (Join-Path $_.FullName "CMakeLists.txt") } | Select-Object -First 1
          if ($null -eq $candidate) {
            Write-Error "Couldn't locate source root (CMakeLists.txt) after extraction."
            exit 1
          }
          $srcDir = $candidate.FullName
        }
        "SRC_DIR=$srcDir" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "Source root: $srcDir"

    - name: Download Skia for Windows
      shell: pwsh
      run: |
        $skiaVersion = "${{ needs.get-skia-version.outputs.version }}"
        $skiaUrl = "https://github.com/aseprite/skia/releases/download/$skiaVersion/Skia-Windows-Release-x64.zip"
        Write-Host "Downloading Skia from: $skiaUrl"
        Invoke-WebRequest -Uri $skiaUrl -OutFile "skia-windows.zip"
        New-Item -ItemType Directory -Path "deps" -Force | Out-Null
        Expand-Archive -Path "skia-windows.zip" -DestinationPath "deps/skia"
        if (-not (Test-Path "deps/skia/out/Release-x64")) { Write-Error "Skia extraction failed"; exit 1 }

    - name: Configure CMake (Windows, static, WinSSL)
      shell: pwsh
      run: |
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        New-Item -ItemType Directory -Path build | Out-Null
        cd build
        cmake -G Ninja `
          -DCMAKE_BUILD_TYPE=RelWithDebInfo `
          -DBUILD_SHARED_LIBS=OFF `
          -DLAF_BACKEND=skia `
          -DSKIA_DIR="${{ github.workspace }}/deps/skia" `
          -DSKIA_LIBRARY_DIR="${{ github.workspace }}/deps/skia/out/Release-x64" `
          -DSKIA_LIBRARY="${{ github.workspace }}/deps/skia/out/Release-x64/skia.lib" `
          -DUSE_SHARED_CURL=OFF `
          -DUSE_SHARED_ZLIB=OFF `
          -DUSE_SHARED_LIBPNG=OFF `
          -DCURL_STATICLIB=ON `
          -DHTTP_ONLY=ON `
          -DCMAKE_USE_OPENSSL=OFF `
          -DCMAKE_USE_SCHANNEL=ON `
          -DCURL_USE_OPENSSL=OFF `
          -DCURL_USE_SCHANNEL=ON `
          -DCMAKE_USE_LIBSSH2=OFF `
          -DCURL_USE_LIBSSH2=OFF `
          -DCMAKE_DISABLE_FIND_PACKAGE_OpenSSL=ON `
          "$env:SRC_DIR"
        Write-Host "==== SSL/CURL related CMakeCache entries ===="
        Get-Content .\CMakeCache.txt | Select-String `
          -Pattern 'CURL_USE_(OPENSSL|SCHANNEL|LIBSSH2)|CURL_SSL_BACKEND|CURL_STATICLIB|HTTP_ONLY|CMAKE_USE_(OPENSSL|SCHANNEL|LIBSSH2)|CMAKE_DISABLE_FIND_PACKAGE_OpenSSL|OPENSSL_' `
          | ForEach-Object { $_.Line }

    - name: Build (Windows)
      run: |
        cd build
        ninja aseprite

    - name: Add i18n strings (Windows)
      shell: pwsh
      run: |
        $stringsUrl = "https://github.com/aseprite/strings/archive/refs/heads/main.zip"
        Invoke-WebRequest -Uri $stringsUrl -OutFile strings.zip
        if (Test-Path strings-src) { Remove-Item -Recurse -Force strings-src }
        New-Item -ItemType Directory -Path strings-src | Out-Null
        Expand-Archive -Path strings.zip -DestinationPath strings-src
        $root = Get-ChildItem "strings-src" -Directory | Select-Object -First 1
        New-Item -ItemType Directory -Path "build/bin/data/strings" -Force | Out-Null
        Copy-Item -Path (Join-Path $root.FullName '*') -Destination "build/bin/data/strings" -Recurse -Force
        Write-Host "strings copied to build/bin/data/strings"

    - name: Verify no OpenSSL DLL dependency
      shell: pwsh
      run: |
        cd build\bin
        $deps = & dumpbin /DEPENDENTS .\aseprite.exe
        $deps | Out-Host
        if ($deps -match 'libcrypto' -or $deps -match 'libssl') {
          Write-Error "aseprite.exe still depends on OpenSSL DLLs."
          exit 1
        }

    - name: Package Windows build
      run: |
        Compress-Archive -Path build/bin/* -DestinationPath aseprite-windows.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-windows
        path: aseprite-windows.zip

  build-macos:
    runs-on: macos-latest
    needs: [get-skia-version, get-aseprite-source]
    steps:
    - name: Install macOS dependencies
      run: |
        brew update
        brew uninstall --ignore-dependencies cmake || true
        brew install cmake ninja

    - name: Download Aseprite Source (latest release)
      run: |
        URL="${{ needs.get-aseprite-source.outputs.url }}"
        TAG="${{ needs.get-aseprite-source.outputs.tag }}"
        echo "Downloading Aseprite Source ($TAG) from $URL"
        curl -L "$URL" -o aseprite-source.zip
        SIZE=$(stat -f%z aseprite-source.zip)
        if [ "$SIZE" -lt 5000000 ]; then
          echo "Source.zip seems too small ($SIZE bytes)."
          exit 1
        fi
        rm -rf aseprite-src
        mkdir -p aseprite-src
        unzip -q aseprite-source.zip -d aseprite-src

        if [ -f "aseprite-src/CMakeLists.txt" ]; then
          SRC_DIR="$GITHUB_WORKSPACE/aseprite-src"
        else
          SRC_DIR=""
          for d in aseprite-src/*/; do
            [ -f "$d/CMakeLists.txt" ] && SRC_DIR="$GITHUB_WORKSPACE/${d%/}" && break
          done
          if [ -z "$SRC_DIR" ]; then
            echo "Couldn't locate source root (CMakeLists.txt) after extraction."
            exit 1
          fi
        fi
        echo "SRC_DIR=$SRC_DIR" >> "$GITHUB_ENV"
        echo "Source root: $SRC_DIR"

    - name: Download Skia (macOS Intel)
      run: |
        SKIA_VERSION="${{ needs.get-skia-version.outputs.version }}"
        SKIA_URL="https://github.com/aseprite/skia/releases/download/$SKIA_VERSION/Skia-macOS-Release-x64.zip"
        echo "Downloading Skia from: $SKIA_URL"
        curl -L "$SKIA_URL" -o skia-macos.zip
        FILE_SIZE=$(stat -f%z skia-macos.zip)
        [ "$FILE_SIZE" -lt 10000000 ] && echo "Skia file too small" && exit 1
        mkdir -p deps/skia
        unzip -q skia-macos.zip -d deps/skia
        [ ! -d "deps/skia/out/Release-x64" ] && echo "Skia extraction failed" && exit 1

    - name: Configure CMake (macOS Intel)
      run: |
        SDK_PATH=$(xcrun --show-sdk-path)
        mkdir -p build
        cd build
        cmake -G Ninja \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=10.9 \
          -DCMAKE_OSX_SYSROOT="$SDK_PATH" \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR="$GITHUB_WORKSPACE/deps/skia" \
          -DSKIA_LIBRARY_DIR="$GITHUB_WORKSPACE/deps/skia/out/Release-x64" \
          -DSKIA_LIBRARY="$GITHUB_WORKSPACE/deps/skia/out/Release-x64/libskia.a" \
          "$SRC_DIR"

    - name: Build (macOS Intel)
      run: |
        cd build
        ninja aseprite

    - name: Add i18n strings (macOS Intel)
      run: |
        STRINGS_URL="https://github.com/aseprite/strings/archive/refs/heads/main.zip"
        curl -L "$STRINGS_URL" -o strings.zip
        rm -rf strings-src
        mkdir -p strings-src
        unzip -q strings.zip -d strings-src
        ROOT_DIR=$(find strings-src -maxdepth 1 -type d -name "strings-*" | head -n 1)
        mkdir -p build/bin/data/strings
        cp -R "$ROOT_DIR"/* build/bin/data/strings/
        echo "strings copied to build/bin/data/strings"

    - name: Package macOS Intel build
      run: |
        tar -czvf aseprite-macos.tar.gz -C build/bin .

    - name: Upload macOS Intel artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-macos
        path: aseprite-macos.tar.gz

  build-macos-arm:
    runs-on: macos-latest
    needs: [get-skia-version, get-aseprite-source]
    steps:
    - name: Install macOS dependencies
      run: |
        brew update
        brew uninstall --ignore-dependencies cmake || true
        brew install cmake ninja

    - name: Download Aseprite Source (latest release)
      run: |
        URL="${{ needs.get-aseprite-source.outputs.url }}"
        TAG="${{ needs.get-aseprite-source.outputs.tag }}"
        echo "Downloading Aseprite Source ($TAG) from $URL"
        curl -L "$URL" -o aseprite-source.zip
        SIZE=$(stat -f%z aseprite-source.zip)
        [ "$SIZE" -lt 5000000 ] && echo "Source.zip too small" && exit 1
        rm -rf aseprite-src
        mkdir -p aseprite-src
        unzip -q aseprite-source.zip -d aseprite-src

        if [ -f "aseprite-src/CMakeLists.txt" ]; then
          SRC_DIR="$GITHUB_WORKSPACE/aseprite-src"
        else
          SRC_DIR=""
          for d in aseprite-src/*/; do
            [ -f "$d/CMakeLists.txt" ] && SRC_DIR="$GITHUB_WORKSPACE/${d%/}" && break
          done
          if [ -z "$SRC_DIR" ]; then
            echo "Couldn't locate source root (CMakeLists.txt) after extraction."
            exit 1
          fi
        fi
        echo "SRC_DIR=$SRC_DIR" >> "$GITHUB_ENV"
        echo "Source root: $SRC_DIR"

    - name: Download Skia (macOS ARM)
      run: |
        SKIA_VERSION="${{ needs.get-skia-version.outputs.version }}"
        SKIA_URL="https://github.com/aseprite/skia/releases/download/$SKIA_VERSION/Skia-macOS-Release-arm64.zip"
        echo "Downloading Skia from: $SKIA_URL"
        curl -L "$SKIA_URL" -o skia-macos-arm.zip
        FILE_SIZE=$(stat -f%z skia-macos-arm.zip)
        [ "$FILE_SIZE" -lt 10000000 ] && echo "Skia file too small" && exit 1
        mkdir -p deps/skia
        unzip -q skia-macos-arm.zip -d deps/skia
        [ ! -d "deps/skia/out/Release-arm64" ] && echo "Skia extraction failed" && exit 1

    - name: Configure CMake (macOS ARM)
      run: |
        SDK_PATH=$(xcrun --show-sdk-path)
        mkdir -p build
        cd build
        cmake -G Ninja \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DCMAKE_OSX_SYSROOT="$SDK_PATH" \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR="$GITHUB_WORKSPACE/deps/skia" \
          -DSKIA_LIBRARY_DIR="$GITHUB_WORKSPACE/deps/skia/out/Release-arm64" \
          -DSKIA_LIBRARY="$GITHUB_WORKSPACE/deps/skia/out/Release-arm64/libskia.a" \
          -DPNG_ARM_NEON=on \
          "$SRC_DIR"

    - name: Build (macOS ARM)
      run: |
        cd build
        ninja aseprite

    - name: Add i18n strings (macOS ARM)
      run: |
        STRINGS_URL="https://github.com/aseprite/strings/archive/refs/heads/main.zip"
        curl -L "$STRINGS_URL" -o strings.zip
        rm -rf strings-src
        mkdir -p strings-src
        unzip -q strings.zip -d strings-src
        ROOT_DIR=$(find strings-src -maxdepth 1 -type d -name "strings-*" | head -n 1)
        mkdir -p build/bin/data/strings
        cp -R "$ROOT_DIR"/* build/bin/data/strings/
        echo "strings copied to build/bin/data/strings"

    - name: Package macOS ARM build
      run: |
        tar -czvf aseprite-macos-arm.tar.gz -C build/bin .

    - name: Upload macOS ARM artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-macos-arm
        path: aseprite-macos-arm.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    needs: [get-skia-version, get-aseprite-source]
    steps:
    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build libx11-dev libxcursor-dev libxi-dev libgl1-mesa-dev libfontconfig1-dev libx11-xcb-dev

    - name: Download Aseprite Source (latest release)
      run: |
        URL="${{ needs.get-aseprite-source.outputs.url }}"
        TAG="${{ needs.get-aseprite-source.outputs.tag }}"
        echo "Downloading Aseprite Source ($TAG) from $URL"
        wget "$URL" -O aseprite-source.zip
        SIZE=$(stat -c%s aseprite-source.zip)
        [ "$SIZE" -lt 5000000 ] && echo "Source.zip too small" && exit 1
        rm -rf aseprite-src
        mkdir -p aseprite-src
        unzip -q aseprite-source.zip -d aseprite-src

        if [ -f "aseprite-src/CMakeLists.txt" ]; then
          SRC_DIR="$GITHUB_WORKSPACE/aseprite-src"
        else
          SRC_DIR=""
          for d in aseprite-src/*/; do
            [ -f "$d/CMakeLists.txt" ] && SRC_DIR="$GITHUB_WORKSPACE/${d%/}" && break
          done
          if [ -z "$SRC_DIR" ]; then
            echo "Couldn't locate source root (CMakeLists.txt) after extraction."
            exit 1
          fi
        fi
        echo "SRC_DIR=$SRC_DIR" >> "$GITHUB_ENV"
        echo "Source root: $SRC_DIR"

    - name: Download Skia (Linux)
      run: |
        SKIA_VERSION="${{ needs.get-skia-version.outputs.version }}"
        SKIA_URL="https://github.com/aseprite/skia/releases/download/$SKIA_VERSION/Skia-Linux-Release-x64.zip"
        echo "Downloading Skia from: $SKIA_URL"
        wget "$SKIA_URL" -O skia-linux.zip
        FILE_SIZE=$(stat -c%s skia-linux.zip)
        [ "$FILE_SIZE" -lt 10000000 ] && echo "Skia file too small" && exit 1
        mkdir -p deps/skia
        unzip -q skia-linux.zip -d deps/skia
        [ ! -d "deps/skia/out/Release-x64" ] && echo "Skia extraction failed" && exit 1

    - name: Configure CMake (Linux)
      run: |
        mkdir -p build
        cd build
        cmake -G Ninja \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DLAF_BACKEND=skia \
          -DSKIA_DIR=$GITHUB_WORKSPACE/deps/skia \
          -DSKIA_LIBRARY_DIR=$GITHUB_WORKSPACE/deps/skia/out/Release-x64 \
          -DSKIA_LIBRARY=$GITHUB_WORKSPACE/deps/skia/out/Release-x64/libskia.a \
          "$SRC_DIR"

    - name: Build (Linux)
      run: |
        cd build
        ninja aseprite

    - name: Add i18n strings (Linux)
      run: |
        STRINGS_URL="https://github.com/aseprite/strings/archive/refs/heads/main.zip"
        wget "$STRINGS_URL" -O strings.zip
        rm -rf strings-src
        mkdir -p strings-src
        unzip -q strings.zip -d strings-src
        ROOT_DIR=$(find strings-src -maxdepth 1 -type d -name "strings-*" | head -n 1)
        mkdir -p build/bin/data/strings
        cp -R "$ROOT_DIR"/* build/bin/data/strings/
        echo "strings copied to build/bin/data/strings"

    - name: Package Linux build
      run: |
        tar -czvf aseprite-linux.tar.gz -C build/bin .

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: aseprite-linux
        path: aseprite-linux.tar.gz

  create-release:
    name: Create Draft Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos, build-macos-arm, build-linux]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        merge-multiple: true

    - name: Verify Artifacts
      run: |
        echo "Listing artifacts:"
        ls -la artifacts/
        [ -f "artifacts/aseprite-windows.zip" ] && echo "Windows artifact OK" || echo "Windows artifact MISSING"
        [ -f "artifacts/aseprite-macos.tar.gz" ] && echo "macOS Intel artifact OK" || echo "macOS Intel artifact MISSING"
        [ -f "artifacts/aseprite-macos-arm.tar.gz" ] && echo "macOS ARM artifact OK" || echo "macOS ARM artifact MISSING"
        [ -f "artifacts/aseprite-linux.tar.gz" ] && echo "Linux artifact OK" || echo "Linux artifact MISSING"

    - name: Create Draft Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: auto-build-${{ github.run_id }}
        name: "Autobuild #${{ github.run_number }} (${{ github.sha }})"
        body: |
          Automated build from CI
          - Trigger: ${{ github.event_name }}
          - Commit: ${{ github.sha }}
          - Build ID: ${{ github.run_id }}
          ${{ github.event_name == 'workflow_dispatch' && format('- Manual trigger by: {0}', github.actor) || '' }}
        draft: true
        prerelease: false
        files: |
          artifacts/aseprite-windows.zip
          artifacts/aseprite-macos.tar.gz
          artifacts/aseprite-macos-arm.tar.gz
          artifacts/aseprite-linux.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
